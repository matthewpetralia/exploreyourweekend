{%- assign cdn_prefix = "https://cdn.exploreyourweekend.com/cdn-cgi/image/quality=70,fit=cover,gravity=auto,format=webp,width=" -%}
{% comment %} {%- assign imagesIncluded = images -%} {% endcomment %}
{%- assign altTags = include.altTags -%}
{% comment %} {%- if imagesIncluded == nil and slugName != nil -%}
                                {%- assign imagesIncluded = slugName | append: ".webp" -%}
                              {%- else -%}
                                {%- assign imagesIncluded = images -%}
{%- endif -%} {% endcomment %}

{%- if images -%}
  {%- assign imagesIncluded = images -%}
{%- elsif slugName != '' -%}
  {%- assign imagesIncluded = slugName | append: ".webp" -%}
{%- endif -%}


{%- assign mode = include.mode | default: "single" -%}

{%- assign ar = include.aspect_ratio | default: aspect_ratio | default: "3:4" -%}
{%- assign aspect_ratio_parts = ar | split: ":" -%}
{%- assign width_ratio = aspect_ratio_parts[0] | plus: 0 -%}
{%- assign height_ratio = aspect_ratio_parts[1] | plus: 0 -%}
{%- assign widths = "362, 480, 592, 640, 768, 800" | split: ", " -%}

<!-- DEBUG: Mode: {{ mode }}, ImagesIncluded count: {{ images | size }} -->

{%- if mode == "gallery" -%}
{%- assign image_count = imagesIncluded | size -%}

  {%- comment -%} Determine the layout class, capping at 6 since that's the max defined in the CSS {%- endcomment -%}
  {%- assign layout_class_num = image_count -%}
  {%- if image_count > 6 -%}
    {%- assign layout_class_num = 6 -%}
  {%- endif -%}

  <div class="multiImage layout-{{ layout_class_num }}">
    {%- for filename in imagesIncluded -%}
      {%- assign current_alt = altTags[forloop.index0] | default: "Gallery image" -%}
      <div class="image-wrapper">
        <img
          src="{{ cdn_prefix }}362/{{ filename }}"
          srcset="
            {%- for width in widths -%}
              {{ cdn_prefix }}{{ width }}/{{ filename }} {{ width }}w
              {%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}"
          sizes="{{ sizes_attr }}"
          width="362"
          height="483"
          alt="{{ current_alt }}"
          itemprop="image"
          decoding="async"
          {%- if forloop.first -%}
          fetchpriority="high"
          {%- else -%}
          loading="lazy"
          {%- endif -%}>
      </div>
    {%- endfor -%}
  </div>

{%- else -%}
  {%- if images -%}
    {%- assign filename = imagesIncluded | first -%}
  {%- else -%}
    {%- assign filename = imagesIncluded -%}
  {%- endif -%}
  <!-- DEBUG: Single mode - showing {{ filename }} -->
  <div class="image-wrapper" style="aspect-ratio: {{ width_ratio }} / {{ height_ratio }};">
    <img
      src="{{ cdn_prefix }}362/{{ filename }}"
      srcset="
          {{ cdn_prefix }}362/{{ filename }} 362w,
          {{ cdn_prefix }}480/{{ filename }} 480w,
          {{ cdn_prefix }}592/{{ filename }} 592w,
          {{ cdn_prefix }}640/{{ filename }} 640w,
          {{ cdn_prefix }}768/{{ filename }} 768w,
          {{ cdn_prefix }}800/{{ filename }} 800w"
      sizes="(max-width: 480px) 90vw, (max-width: 768px) 45vw, 30vw"
      width="362"
      height="483"
      alt="{{ altTags[forloop.index0] }}"
      itemprop="image"
      decoding="async"
      fetchpriority="high">
  </div>
{%- endif -%}